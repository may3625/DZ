<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test des Corrections - Dalil.dz</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>üß™ Test des Corrections des Erreurs de Navigateur</h1>
    <p>Cette page teste toutes les corrections appliqu√©es pour r√©soudre les erreurs de navigateur.</p>

    <div class="test-section">
        <h2>1. Test des Scripts de Correction</h2>
        <button onclick="testScripts()">Tester les Scripts</button>
        <div id="scripts-status"></div>
    </div>

    <div class="test-section">
        <h2>2. Test des Fonctionnalit√©s Non Reconnues</h2>
        <button onclick="testUnrecognizedFeatures()">Tester les Fonctionnalit√©s</button>
        <div id="features-status"></div>
    </div>

    <div class="test-section">
        <h2>3. Test des APIs Probl√©matiques</h2>
        <button onclick="testProblematicAPIs()">Tester les APIs</button>
        <div id="apis-status"></div>
    </div>

    <div class="test-section">
        <h2>4. Test de la Configuration CSP</h2>
        <button onclick="testCSP()">Tester la CSP</button>
        <div id="csp-status"></div>
    </div>

    <div class="test-section">
        <h2>5. Test des Cookies et Permissions</h2>
        <button onclick="testCookiesAndPermissions()">Tester Cookies & Permissions</button>
        <div id="cookies-status"></div>
    </div>

    <div class="test-section">
        <h2>6. Test Complet</h2>
        <button onclick="runAllTests()">Lancer Tous les Tests</button>
        <div id="complete-status"></div>
    </div>

    <div class="test-section">
        <h2>7. Diagnostic Complet</h2>
        <button onclick="runDiagnostics()">Lancer le Diagnostic</button>
        <div id="diagnostic-result"></div>
    </div>

    <script>
        // Attendre que tous les scripts soient charg√©s
        window.addEventListener('load', function() {
            console.log('üöÄ Page de test charg√©e - Pr√™t pour les tests');
        });

        function testScripts() {
            const status = document.getElementById('scripts-status');
            let results = [];
            
            // Test des scripts de correction
            if (window.__VITE_STATIC_CLIENT__) {
                results.push('‚úÖ Client Vite statique charg√©');
            } else {
                results.push('‚ùå Client Vite statique non charg√©');
            }

            if (window.__BROWSER_ERRORS_FIXED__) {
                results.push('‚úÖ Erreurs de navigateur corrig√©es');
            } else {
                results.push('‚ùå Erreurs de navigateur non corrig√©es');
            }

            if (window.__CSP_CONFIGURED__) {
                results.push('‚úÖ CSP configur√©e');
            } else {
                results.push('‚ùå CSP non configur√©e');
            }

            if (window.__FEATURE_POLICY_CONFIGURED__) {
                results.push('‚úÖ Politique de fonctionnalit√©s configur√©e');
            } else {
                results.push('‚ùå Politique de fonctionnalit√©s non configur√©e');
            }

            const successCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = results.length;
            
            status.innerHTML = `
                <div class="status ${successCount === totalCount ? 'success' : 'warning'}">
                    <strong>R√©sultats:</strong> ${successCount}/${totalCount} tests r√©ussis
                </div>
                <pre>${results.join('\n')}</pre>
            `;
        }

        function testUnrecognizedFeatures() {
            const status = document.getElementById('features-status');
            let results = [];
            
            // Test VR
            try {
                if (navigator.getVRDisplays) {
                    const vrTest = navigator.getVRDisplays();
                    if (vrTest.then) {
                        results.push('‚úÖ API VR disponible (polyfill)');
                    } else {
                        results.push('‚ö†Ô∏è API VR disponible mais pas de polyfill');
                    }
                } else {
                    results.push('‚ùå API VR non disponible');
                }
            } catch (e) {
                results.push('‚úÖ API VR g√©r√©e par la politique de fonctionnalit√©s');
            }

            // Test AmbientLightSensor
            try {
                if (window.AmbientLightSensor) {
                    new window.AmbientLightSensor();
                    results.push('‚ùå AmbientLightSensor accessible (devrait √™tre bloqu√©)');
                } else {
                    results.push('‚úÖ AmbientLightSensor bloqu√©');
                }
            } catch (e) {
                results.push('‚úÖ AmbientLightSensor correctement bloqu√©');
            }

            // Test Battery
            try {
                if (navigator.getBattery) {
                    const batteryTest = navigator.getBattery();
                    if (batteryTest.then) {
                        results.push('‚úÖ API Batterie disponible (polyfill)');
                    } else {
                        results.push('‚ö†Ô∏è API Batterie disponible mais pas de polyfill');
                    }
                } else {
                    results.push('‚ùå API Batterie non disponible');
                }
            } catch (e) {
                results.push('‚úÖ API Batterie g√©r√©e par la politique de fonctionnalit√©s');
            }

            const successCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = results.length;
            
            status.innerHTML = `
                <div class="status ${successCount === totalCount ? 'success' : 'warning'}">
                    <strong>R√©sultats:</strong> ${successCount}/${totalCount} tests r√©ussis
                </div>
                <pre>${results.join('\n')}</pre>
            `;
        }

        function testProblematicAPIs() {
            const status = document.getElementById('apis-status');
            let results = [];
            
            // Test des capteurs de mouvement
            const motionSensors = ['Accelerometer', 'Gyroscope', 'Magnetometer'];
            motionSensors.forEach(sensorName => {
                try {
                    if (window[sensorName]) {
                        new window[sensorName]();
                        results.push(`‚ùå ${sensorName} accessible (devrait √™tre bloqu√©)`);
                    } else {
                        results.push(`‚úÖ ${sensorName} bloqu√©`);
                    }
                } catch (e) {
                    results.push(`‚úÖ ${sensorName} correctement bloqu√©`);
                }
            });

            // Test des permissions
            if (navigator.permissions) {
                results.push('‚úÖ API Permissions disponible');
            } else {
                results.push('‚ö†Ô∏è API Permissions non support√©e');
            }

            const successCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = results.length;
            
            status.innerHTML = `
                <div class="status ${successCount === totalCount ? 'success' : 'warning'}">
                    <strong>R√©sultats:</strong> ${successCount}/${totalCount} tests r√©ussis
                </div>
                <pre>${results.join('\n')}</pre>
            `;
        }

        function testCSP() {
            const status = document.getElementById('csp-status');
            let results = [];
            
            // V√©rifier la meta CSP
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (cspMeta) {
                results.push('‚úÖ Meta CSP pr√©sente');
                results.push(`üìã Contenu: ${cspMeta.content.substring(0, 100)}...`);
            } else {
                results.push('‚ùå Meta CSP manquante');
            }

            // V√©rifier la meta Feature Policy
            const fpMeta = document.querySelector('meta[http-equiv="Feature-Policy"]');
            if (fpMeta) {
                results.push('‚úÖ Meta Feature Policy pr√©sente');
                results.push(`üìã Contenu: ${fpMeta.content.substring(0, 100)}...`);
            } else {
                results.push('‚ùå Meta Feature Policy manquante');
            }

            // Test des fonctions de diagnostic
            if (typeof window.diagnoseCSP === 'function') {
                results.push('‚úÖ Fonction diagnoseCSP disponible');
            } else {
                results.push('‚ùå Fonction diagnoseCSP manquante');
            }

            if (typeof window.diagnoseFeaturePolicy === 'function') {
                results.push('‚úÖ Fonction diagnoseFeaturePolicy disponible');
            } else {
                results.push('‚ùå Fonction diagnoseFeaturePolicy manquante');
            }

            const successCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = results.length;
            
            status.innerHTML = `
                <div class="status ${successCount === totalCount ? 'success' : 'warning'}">
                    <strong>R√©sultats:</strong> ${successCount}/${totalCount} tests r√©ussis
                </div>
                <pre>${results.join('\n')}</pre>
            `;
        }

        function testCookiesAndPermissions() {
            const status = document.getElementById('cookies-status');
            let results = [];
            
            // Test des cookies
            try {
                const testCookie = `test_${Date.now()}=1`;
                document.cookie = testCookie;
                
                if (document.cookie.includes(testCookie)) {
                    results.push('‚úÖ Cookies fonctionnels');
                    // Nettoyer le cookie de test
                    document.cookie = `${testCookie}; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
                } else {
                    results.push('‚ö†Ô∏è Cookies d√©sactiv√©s ou bloqu√©s');
                }
            } catch (e) {
                results.push('‚ùå Erreur lors du test des cookies');
            }

            // Test des permissions
            if (navigator.permissions) {
                results.push('‚úÖ API Permissions disponible');
                
                // Test des permissions sp√©cifiques
                const testPermissions = ['camera', 'microphone', 'geolocation'];
                testPermissions.forEach(permission => {
                    try {
                        navigator.permissions.query({ name: permission }).then(result => {
                            results.push(`‚ÑπÔ∏è Permission ${permission}: ${result.state}`);
                        }).catch(() => {
                            results.push(`‚ÑπÔ∏è Permission ${permission} non support√©e`);
                        });
                    } catch (e) {
                        results.push(`‚ö†Ô∏è Erreur test permission ${permission}`);
                    }
                });
            } else {
                results.push('‚ö†Ô∏è API Permissions non disponible');
            }

            const successCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = results.length;
            
            status.innerHTML = `
                <div class="status ${successCount === totalCount ? 'success' : 'warning'}">
                    <strong>R√©sultats:</strong> ${successCount}/${totalCount} tests r√©ussis
                </div>
                <pre>${results.join('\n')}</pre>
            `;
        }

        function runAllTests() {
            const status = document.getElementById('complete-status');
            status.innerHTML = '<div class="status info">üîÑ Lancement de tous les tests...</div>';
            
            setTimeout(() => {
                testScripts();
                testUnrecognizedFeatures();
                testProblematicAPIs();
                testCSP();
                testCookiesAndPermissions();
                
                status.innerHTML = '<div class="status success">‚úÖ Tous les tests ont √©t√© lanc√©s. V√©rifiez les r√©sultats ci-dessus.</div>';
            }, 100);
        }

        function runDiagnostics() {
            const status = document.getElementById('diagnostic-result');
            status.innerHTML = '<div class="status info">üîç Lancement du diagnostic complet...</div>';
            
            let diagnosticResults = [];
            
            // Diagnostic CSP
            if (typeof window.diagnoseCSP === 'function') {
                try {
                    window.diagnoseCSP();
                    diagnosticResults.push('‚úÖ Diagnostic CSP ex√©cut√©');
                } catch (e) {
                    diagnosticResults.push(`‚ùå Erreur diagnostic CSP: ${e.message}`);
                }
            } else {
                diagnosticResults.push('‚ùå Fonction diagnoseCSP non disponible');
            }

            // Diagnostic Feature Policy
            if (typeof window.diagnoseFeaturePolicy === 'function') {
                try {
                    window.diagnoseFeaturePolicy();
                    diagnosticResults.push('‚úÖ Diagnostic Feature Policy ex√©cut√©');
                } catch (e) {
                    diagnosticResults.push(`‚ùå Erreur diagnostic Feature Policy: ${e.message}`);
                }
            } else {
                diagnosticResults.push('‚ùå Fonction diagnoseFeaturePolicy non disponible');
            }

            // √âtat global
            diagnosticResults.push('üìä √âtat global:');
            diagnosticResults.push(`  - Client Vite: ${window.__VITE_STATIC_CLIENT__ || 'Non configur√©'}`);
            diagnosticResults.push(`  - Erreurs corrig√©es: ${window.__BROWSER_ERRORS_FIXED__ || 'Non configur√©'}`);
            diagnosticResults.push(`  - CSP: ${window.__CSP_CONFIGURED__ || 'Non configur√©'}`);
            diagnosticResults.push(`  - Feature Policy: ${window.__FEATURE_POLICY_CONFIGURED__ || 'Non configur√©'}`);

            status.innerHTML = `
                <div class="status success">‚úÖ Diagnostic termin√©</div>
                <pre>${diagnosticResults.join('\n')}</pre>
                <p><strong>üí° V√©rifiez la console du navigateur pour plus de d√©tails.</strong></p>
            `;
        }
    </script>
</body>
</html>